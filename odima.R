ODIMAstat = function(exposure, mediator, response){
  EM = bcdcor(exposure, mediator)
  MRE = pdcor(mediator, response, exposure)
  ODIMAstat <- EM*MRE
  attr(ODIMAstat, "names") <- "ODIMA stat"
  return(ODIMAstat)
}

permuteDist = function(d){
  d=as.matrix(d)
  n=nrow(d)
  p=sample(n)
  as.dist(d[p,p])
}

odima = function(exposure, mediator, response, nrep=999){
  method <- "WARNING:Specify the number of replicates nrep>0 to perform the test"
  if (!is.null(nrep)){
    nrep <- floor(nrep)
    if (nrep <1)
      nrep <- 0
    if (nrep > 0)
      method <- paste("ODIMA: Omnibus Distance Mediation Analysis")
  }
  else {
    nrep <- 0
  }
  if(bcdcor(exposure, mediator)< pdcor(mediator, response, exposure)){
    S <- replicate(nrep,expr = bcdcor(permuteDist(exposure),mediator)*pdcor(mediator, response, exposure))
  }
  else{
    S <- replicate(nrep, expr = bcdcor(exposure,mediator)*pdcor(mediator, permuteDist(response), exposure))
  }
  p.value <- ifelse( nrep>0, ((1+sum(S>ODIMAstat(exposure, mediator, response)))/(nrep+1)), 1)
  bcdcorEM <- bcdcor(exposure, mediator)
  bcdcorER <- bcdcor(exposure, response)
  bcdcorMR <- bcdcor(mediator, response)
  pdcorMRE <- pdcor(mediator, response, exposure)
  attr(bcdcorEM, "names") <- paste0(deparse(substitute(exposure)), "\u2013", deparse(substitute(mediator)), " bcdcor")
  attr(bcdcorER, "names") <- paste0(deparse(substitute(exposure)), "\u2013", deparse(substitute(response)), " bcdcor")
  attr(bcdcorMR, "names") <- paste0(deparse(substitute(mediator)), "\u2013", deparse(substitute(response)), " bcdcor")
  attr(pdcorMRE, "names") <- paste0(deparse(substitute(mediator)), "\u2013", deparse(substitute(response)), "\u2013", deparse(substitute(exposure)), " pdcor")
  e <- list(method = method,
            data.name = base::paste("number of permutations + 1:", nrep+1,
                              "\n sample estimates are \n \t-bias-corrected distance correlation (bcdcor) of indicated pairs and \n \t-partial distance correlation (pdcor) of indicated triple"
                           #deparse(substitute(exposure)), "and", deparse(substitute(mediator)), "removing", deparse(substitute(response))
                                    ),
            statistic = ODIMAstat(exposure, mediator, response), 
            p.value = p.value,
            estimates = c(bcdcorEM, bcdcorER, bcdcorMR, pdcorMRE)
            #other options for getAnywhere(htest): parameter, alternative, null.value, conf.int
            )
  class(e) <- "htest"
  return(e)
  }

subset.distance = function(d, sub) as.dist(as.matrix(d)[sub, sub])
